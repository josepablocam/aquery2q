// Moving variance calculation for technology stocks
CREATE TABLE prices (
  Open          FLOAT,
  High          FLOAT,
  Low           FLOAT,
  Close         FLOAT,
  Volume        FLOAT,
  EndOfDayPrice FLOAT,
  ID            STRING,
  Date          DATE
)

LOAD DATA INFILE "./data/sp500_eod_complete_data.csv" INTO TABLE prices
FIELDS TERMINATED BY  ","

// moving variance for technology stocks
WITH
  variances(Date, ID, mv) AS (
    SELECT Date, ID,
      vars(12, ratios(1, EndOfDayPrice) - 1)
      FROM prices
      ASSUMING ASC Date
      WHERE ID in ("HP", "ORCL", "YHOO")
      AND Date >= '01/01/2015'
      GROUP BY ID
  )

SELECT * FROM FLATTEN(variances)


// Correlation of returns calculation for simulated data
<q>
\S 1
corrTickers10:neg[10]?exec distinct ID from prices
</q>

WITH
  stocksGrouped(ID, Ret) AS (
    SELECT ID, ratios(1, EndOfDayPrice) - 1
    FROM prices
    ASSUMING ASC ID, ASC Date
    WHERE ID in corrTickers10 AND
    Date >= max(Date) - 31 * 6
    GROUP BY ID)

  pairsGrouped(ID1, ID2, R1, R2) AS (
    SELECT st1.ID, st2.ID, 
    st1.Ret, st2.Ret
    FROM stocksGrouped st1, stocksGrouped st2)
  
SELECT ID1, ID2,
cor(R1, R2) as coef 
FROM FLATTEN(pairsGrouped)
WHERE ID1 != ID2
GROUP BY ID1, ID2






